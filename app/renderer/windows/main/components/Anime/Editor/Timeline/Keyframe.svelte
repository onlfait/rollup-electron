<script>
  import { getContext } from "svelte";
  import { createEventDispatcher } from "svelte";
  import pannable from "../../../pannable.js";

  const dispatch = createEventDispatcher();
  const { selectedKeyframe, pixelPerMs, timeline } = getContext("Editor");
  const { scale } = timeline;

  export let keyframe;

  let halfWidth = 10;

  $: width = keyframe.duration / pixelPerMs * $scale;
  $: left = keyframe.delay / pixelPerMs * $scale - halfWidth;
  $: red = "bg-red-500 bg-opacity-50 border border-red-600 border-opacity-50";
  $: blue = "bg-blue-500 bg-opacity-50 border border-blue-600 border-opacity-50";
  $: selectedId = $selectedKeyframe && $selectedKeyframe.id;
  $: selected = selectedId === keyframe.id ? red : blue;

  function onSelect() {
    dispatch("select", keyframe);
  }

  function onPanMove({ detail }) {
    dispatch("move", { keyframe, offset: detail.dx / $scale });
  }

  function onMouseUp({ which, detail }) {
    if (which === 3 && detail === 2) {
      dispatch("remove", keyframe);
    }
  }
</script>

<div
  class="absolute bg-gray-500 bg-opacity-25"
  style="left:{left+halfWidth}px;width:{width}px;height:28.28px">
</div>
<div class="absolute" style="left:{left}px">
  <div
    use:pannable
    on:panmove={onPanMove}
    on:mouseup={onMouseUp}
    on:contextmenu|preventDefault
    on:mousedown|stopPropagation={onSelect}
    class="w-5 h-5 transform rotate-45 {selected} shadow-sm">
  </div>
</div>
